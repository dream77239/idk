-- é”å®šç›®æ ‡è„šæœ¬ v2.2 (PC+Mobile)
-- æ–°å¢åŠŸèƒ½ï¼šæ·»åŠ å¯éšè—/æ˜¾ç¤ºé”å®šæŒ‰é’®çš„å°æ§åˆ¶æŒ‰é’®

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local GuiService = game:GetService("GuiService")
local TweenService = game:GetService("TweenService")

-- é…ç½®åŒºï¼ˆå¯è‡ªå®šä¹‰ï¼‰--
local SETTINGS = {
    LockDuration = 6,          -- é”å®šæŒç»­æ—¶é—´(ç§’)
    FollowDistance = 3,        -- ä¸ç›®æ ‡çš„è·ç¦»(ç±³)
    PcHotkey = Enum.KeyCode.R, -- ç”µè„‘è§¦å‘æŒ‰é”®
    MobileButtonSize = UDim2.new(0.2, 0, 0.1, 0), -- æ‰‹æœºæŒ‰é’®å°ºå¯¸
    MobileButtonPosition = UDim2.new(0.7, 0, 0.8, 0), -- æ‰‹æœºæŒ‰é’®ä½ç½®
    ToggleButtonSize = UDim2.new(0.05, 0, 0.05, 0), -- éšè—/æ˜¾ç¤ºæŒ‰é’®å°ºå¯¸
    ToggleButtonPosition = UDim2.new(0.95, 0, 0.05, 0), -- éšè—/æ˜¾ç¤ºæŒ‰é’®ä½ç½®
    ButtonColor = Color3.fromRGB(0, 120, 255), -- æŒ‰é’®é¢œè‰²
    ToggleButtonColor = Color3.fromRGB(100, 100, 100) -- éšè—/æ˜¾ç¤ºæŒ‰é’®é¢œè‰²
}

-- ç³»ç»Ÿå˜é‡ --
local LocalPlayer = Players.LocalPlayer
local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
local Humanoid = Character:WaitForChild("Humanoid")
local RootPart = Character:WaitForChild("HumanoidRootPart")
local Camera = workspace.CurrentCamera
local followConnection = nil
local mobileUI = {}

-- ç§»åŠ¨è®¾å¤‡UIåˆ›å»º --
local function CreateMobileUI()
    if UserInputService.TouchEnabled and not GuiService:IsTenFootInterface() then
        -- ä¸»ç•Œé¢
        local screenGui = Instance.new("ScreenGui")
        screenGui.Name = "LockTargetUI"
        screenGui.ResetOnSpawn = false
        screenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")
        
        -- é”å®šæŒ‰é’®
        local lockButton = Instance.new("TextButton")
        lockButton.Name = "LockButton"
        lockButton.Size = SETTINGS.MobileButtonSize
        lockButton.Position = SETTINGS.MobileButtonPosition
        lockButton.Text = "ğŸ”’ é”å®šç›®æ ‡"
        lockButton.TextScaled = true
        lockButton.BackgroundColor3 = SETTINGS.ButtonColor
        lockButton.TextColor3 = Color3.new(1, 1, 1)
        lockButton.ZIndex = 10
        lockButton.Visible = true -- é»˜è®¤å¯è§
        
        -- æŒ‰é’®åŠ¨ç”»æ•ˆæœ
        lockButton.MouseButton1Down:Connect(function()
            lockButton.Size = lockButton.Size - UDim2.new(0.02, 0, 0.02, 0)
        end)
        lockButton.MouseButton1Up:Connect(function()
            lockButton.Size = SETTINGS.MobileButtonSize
        end)
        
        -- éšè—/æ˜¾ç¤ºåˆ‡æ¢æŒ‰é’®
        local toggleButton = Instance.new("TextButton")
        toggleButton.Name = "ToggleButton"
        toggleButton.Size = SETTINGS.ToggleButtonSize
        toggleButton.Position = SETTINGS.ToggleButtonPosition
        toggleButton.Text = "â—„" -- é»˜è®¤æ˜¾ç¤ºä¸ºå‘å·¦ç®­å¤´(è¡¨ç¤ºå¯ä»¥éšè—)
        toggleButton.TextScaled = true
        toggleButton.BackgroundColor3 = SETTINGS.ToggleButtonColor
        toggleButton.TextColor3 = Color3.new(1, 1, 1)
        toggleButton.ZIndex = 11 -- æ¯”é”å®šæŒ‰é’®æ›´é«˜
        
        -- åˆ‡æ¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        toggleButton.MouseButton1Click:Connect(function()
            lockButton.Visible = not lockButton.Visible
            toggleButton.Text = lockButton.Visible and "â—„" or "â–º"
            
            -- å°åŠ¨ç”»æ•ˆæœ
            toggleButton.Size = toggleButton.Size - UDim2.new(0.01, 0, 0.01, 0)
            task.wait(0.1)
            toggleButton.Size = SETTINGS.ToggleButtonSize
        end)
        
        lockButton.Parent = screenGui
        toggleButton.Parent = screenGui
        
        mobileUI.screenGui = screenGui
        mobileUI.lockButton = lockButton
        mobileUI.toggleButton = toggleButton
        
        return lockButton, toggleButton
    end
    return nil, nil
end

-- å–æ¶ˆé”å®šåŠŸèƒ½ --
local function CancelLock()
    if followConnection then
        followConnection:Disconnect()
        followConnection = nil
    end
    
    -- æ¢å¤æ§åˆ¶
    if Humanoid then
        Humanoid.WalkSpeed = 16
        Humanoid.JumpPower = 50
        Humanoid.AutoRotate = true
        Humanoid:SetAttribute("IsLocked", false)
    end
    
    -- æç¤ºéŸ³æ•ˆï¼ˆå¯é€‰ï¼‰
    if Character and Character:FindFirstChild("HumanoidRootPart") then
        local sound = Instance.new("Sound")
        sound.SoundId = "rbxassetid://9046892392" -- è§£é”éŸ³æ•ˆID
        sound.Volume = 0.5
        sound.Parent = Character.HumanoidRootPart
        sound:Play()
        game:GetService("Debris"):AddItem(sound, 3)
    end
end

-- æ‰¾åˆ°æœ€è¿‘çš„ç©å®¶ --
local function FindNearestTarget()
    local nearestPlayer, minDistance = nil, math.huge
    
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character then
            local targetRoot = player.Character:FindFirstChild("HumanoidRootPart")
            if targetRoot then
                local distance = (RootPart.Position - targetRoot.Position).Magnitude
                if distance < minDistance then
                    minDistance = distance
                    nearestPlayer = player
                end
            end
        end
    end
    
    return nearestPlayer
end

-- å¹³æ»‘ç¬ç§»å‡½æ•° --
local function SmoothTeleport(cframe)
    if not RootPart then return end
    
    local tweenInfo = TweenInfo.new(
        0.3, -- æŒç»­æ—¶é—´
        Enum.EasingStyle.Quad, -- ç¼“åŠ¨æ ·å¼
        Enum.EasingDirection.Out -- ç¼“åŠ¨æ–¹å‘
    )
    
    local tween = TweenService:Create(RootPart, tweenInfo, {CFrame = cframe})
    tween:Play()
    tween.Completed:Wait()
end

-- é”å®šä¸è·Ÿéšç³»ç»Ÿ --
local function StartLockTarget()
    -- é˜²æ­¢é‡å¤è§¦å‘
    if Humanoid:GetAttribute("IsLocked") then return end
    Humanoid:SetAttribute("IsLocked", true)
    
    -- æ‰¾åˆ°ç›®æ ‡
    local targetPlayer = FindNearestTarget()
    if not targetPlayer or not targetPlayer.Character then
        warn("é”å®šå¤±è´¥ï¼šæœªæ‰¾åˆ°æœ‰æ•ˆç›®æ ‡")
        Humanoid:SetAttribute("IsLocked", false)
        return
    end
    
    local targetRoot = targetPlayer.Character:WaitForChild("HumanoidRootPart")
    
    -- ç¦ç”¨ç©å®¶æ§åˆ¶
    Humanoid.WalkSpeed = 0
    Humanoid.JumpPower = 0
    Humanoid.AutoRotate = false
    
    -- è®¡ç®—åˆå§‹ä½ç½®ï¼ˆç›®æ ‡é¢å‰3ç±³ï¼‰
    local function GetFollowPosition()
        return targetRoot.Position + 
               (targetRoot.CFrame.LookVector * -SETTINGS.FollowDistance) +
               Vector3.new(0, 0.5, 0) -- ç¨å¾®æŠ¬é«˜é˜²æ­¢åœ°é¢ç©¿é€
    end
    
    -- å¹³æ»‘ç¬ç§»åˆ°ç›®æ ‡é¢å‰
    SmoothTeleport(CFrame.new(GetFollowPosition(), targetRoot.Position))
    
    -- æŒç»­è·Ÿéšé€»è¾‘
    followConnection = RunService.Heartbeat:Connect(function()
        if not targetRoot or not RootPart then return end
        
        -- è®¡ç®—æ–°ä½ç½®å¹¶ä¿æŒé¢å‘ç›®æ ‡
        local newCFrame = CFrame.new(GetFollowPosition(), targetRoot.Position)
        RootPart.CFrame = newCFrame
        RootPart.Velocity = Vector3.zero
        
        -- å¯é€‰ï¼šæ‘„åƒå¤´è·Ÿéš
        Camera.CFrame = CFrame.lookAt(
            Camera.CFrame.Position,
            targetRoot.Position
        )
    end)
    
    -- æŠ€èƒ½é‡Šæ”¾éƒ¨åˆ† --
    local function ExecuteSkills()
        -- PingCheck
        local args1 = {
            [1] = {
                ["Goal"] = "PingCheck",
                ["Time"] = os.time()
            }
        }
        Character.Communicate:FireServer(unpack(args1))
        task.wait(0.1)
        
        -- æ£€æŸ¥Vanishing Kick
        local vanishingKick = LocalPlayer.Backpack:FindFirstChild("Vanishing Kick") or 
                             Character:FindFirstChild("Vanishing Kick")
        
        if vanishingKick then
            -- Console Move
            local args2 = {
                [1] = {
                    ["Tool"] = vanishingKick,
                    ["Goal"] = "Console Move"
                }
            }
            Character.Communicate:FireServer(unpack(args2))
            task.wait(0.2)
            
            -- Auto Use End
            local args3 = {
                [1] = {
                    ["Goal"] = "Auto Use End",
                    ["Tool"] = vanishingKick
                }
            }
            Character.Communicate:FireServer(unpack(args3))
        end
    end
    
    -- æ‰§è¡ŒæŠ€èƒ½
    ExecuteSkills()
    
    -- å®šæ—¶è§£é”
    task.delay(SETTINGS.LockDuration, function()
        CancelLock()
    end)
end

-- è¾“å…¥ç³»ç»Ÿåˆå§‹åŒ– --
local function SetupInputSystem()
    -- PCé”®ç›˜ç›‘å¬
    UserInputService.InputBegan:Connect(function(input, gameProcessed)
        if not gameProcessed and input.KeyCode == SETTINGS.PcHotkey then
            StartLockTarget()
        end
    end)
    
    -- ç§»åŠ¨ç«¯æŒ‰é’®ç›‘å¬
    if UserInputService.TouchEnabled then
        local lockButton, toggleButton = CreateMobileUI()
        if lockButton then
            lockButton.Activated:Connect(StartLockTarget)
        end
    end
end

-- è§’è‰²å®‰å…¨ç³»ç»Ÿ --
local function SetupCharacterSafety()
    LocalPlayer.CharacterAdded:Connect(function(newChar)
        Character = newChar
        Humanoid = newChar:WaitForChild("Humanoid")
        RootPart = newChar:WaitForChild("HumanoidRootPart")
        
        -- ç¡®ä¿å±æ€§é‡ç½®
        CancelLock()
        
        -- é‡æ–°åˆ›å»ºUI
        if UserInputService.TouchEnabled then
            if mobileUI.screenGui then
                mobileUI.screenGui:Destroy()
            end
            CreateMobileUI()
        end
    end)
end

-- ä¸»åˆå§‹åŒ–å‡½æ•° --
local function Initialize()
    SetupCharacterSafety()
    SetupInputSystem()
    
    -- åˆå§‹å±æ€§è®¾ç½®
    Humanoid:SetAttribute("IsLocked", false)
    
    print("é”å®šç›®æ ‡ç³»ç»Ÿå·²åŠ è½½ | æŒ‰ "..tostring(SETTINGS.PcHotkey).." é”®æˆ–ä½¿ç”¨æŒ‰é’®è§¦å‘")
end

-- å¯åŠ¨ç³»ç»Ÿ --
Initialize()
